name: "build, push ARM docker image and deploy on Oracle cloud"

run-name: "Build, push ARM docker image and deploy on Oracle cloud"

on: [ push ]

jobs:
  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v2"
      - name: "Set up QEMU"
        uses: "docker/setup-qemu-action@v1"
      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v1"
      - name: "Login to GitHub Package Registry"
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: "Build & Push Docker image"
        run: docker buildx build -t ghcr.io/${{ github.repository_owner }}/demo:latest -f ./Dockerfile --push --platform=linux/arm64,linux/amd64 .

      - name: Deployment on Oracle host
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_TARGET }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          username: ubuntu
          port: 22
          script: |
            ls -al
            whoami